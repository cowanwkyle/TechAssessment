@using UserManagement.Web.Extensions
@using UserManagement.Web.Models.Users
@model UserManagement.Web.Models.Users.UserListViewModel

<h2 class="text-center">User List</h2>

<div class="table-responsive mb-4">
    <table class="table table-striped align-middle">
        <thead class="table-light">
            <tr>
                @foreach (UserListSortField colName in Enum.GetValues(typeof(UserListSortField)))
                {
                    <th>
                        <a asp-action="List"
                           asp-route-sortOrder="@(Model.SortField == colName ? !Model.SortOrder : false)"
                           asp-route-sortField="@(colName)"
                           asp-route-isActive="@(Model.IsActive)"
                           class="text-decoration-none text-reset fw-semibold">
                            @{
                                switch (colName)
                                {
                                    case UserListSortField.Id:
                                        @Html.DisplayNameFor(m => m.PagedItems[0].Id)
                                        ;
                                        break;
                                    case UserListSortField.Forename:
                                        @Html.DisplayNameFor(m => m.PagedItems[0].Forename)
                                        ;
                                        break;
                                    case UserListSortField.Surname:
                                        @Html.DisplayNameFor(m => m.PagedItems[0].Surname)
                                        ;
                                        break;
                                    case UserListSortField.Email:
                                        @Html.DisplayNameFor(m => m.PagedItems[0].Email)
                                        ;
                                        break;
                                    case UserListSortField.IsActive:
                                        @Html.DisplayNameFor(m => m.PagedItems[0].IsActive)
                                        ;
                                        break;
                                    case UserListSortField.DateOfBirth:
                                        @Html.DisplayNameFor(m => m.PagedItems[0].DateOfBirth)
                                        ;
                                        break;
                                }
                            }
                            @if (Model.SortField == colName)
                            {
                                @if (!Model.SortOrder)
                                {
                                    <i class="bi bi-caret-up-fill"></i>
                                }
                                else
                                {
                                    <i class="bi bi-caret-down-fill"></i>
                                }
                            }
                        </a>
                    </th>
                }
                <th style="width: 1px;"></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.PagedItems)
            {
                <tr>
                    <td>
                        @item.Id
                    </td>
                    <td>
                        @item.Forename
                    </td>
                    <td>
                        @item.Surname
                    </td>
                    <td>
                        @item.Email
                    </td>
                    <td>
                        @item.DateOfBirth?.ToString("yyyy-MM-dd")
                    </td>
                    <td>
                        @(item.IsActive ? "Yes" : "No")
                    </td>
                    <td>
                        <div class="dropdown">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="btnToggleActions">
                                Actions
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="btnToggleActions">
                                <li>
                                    <a class="dropdown-item" asp-action="Details" asp-route-id="@item.Id">
                                        <i class="bi bi-info-circle-fill"></i> View
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item"
                                       asp-action="Edit"
                                       asp-route-id="@item.Id"
                                       asp-route-returnUrl="@Url.Action("List", "Users")">
                                        <i class="bi bi-pencil-fill"></i> Edit
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item text-danger"
                                       data-bs-toggle="modal"
                                       data-bs-target="#deleteModal"
                                       data-user-id="@item.Id"
                                       data-user-name="@($"{item.Forename} {item.Surname}")">
                                        <i class="bi bi-trash-fill"></i> Delete
                                    </a>
                                </li>

                            </ul>

                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    @{
        var prevDisabled = !Model.PagedItems.HasPreviousPage ? "disabled" : "";
        var nextDisabled = !Model.PagedItems.HasNextPage ? "disabled" : "";
    }
    <div class="container text-center">
        <div class="row align-items-center mb-3">
            <div class="col-4 text-start">
                <div class="btn-group" role="group">
                    <a asp-controller="Users" asp-action="List"
                       class="btn btn-outline-secondary @(Model.IsActive == null ? "active" : "")">Show All</a>
                    <a asp-controller="Users" asp-action="List" asp-route-isActive="true"
                       class="btn btn-outline-secondary @(Model.IsActive == true ? "active" : "")">Active Only</a>
                    <a asp-controller="Users" asp-action="List" asp-route-isActive="false"
                       class="btn btn-outline-secondary @(Model.IsActive == false ? "active" : "")">Non Active</a>
                </div>
            </div>

            <div class="col-4 text-center">
                <div class="btn-group" role="group">
                    <a asp-controller="Users"
                       asp-action="List"
                       asp-route-isActive="@Model.IsActive"
                       asp-route-sortOrder="@Model.SortOrder"
                       asp-route-sortField="@Model.SortField"
                       asp-route-pageNumber="@(Model.PagedItems.PageIndex - 1)"
                       class="btn btn-outline-primary @(Model.PagedItems.HasPreviousPage ? "" : "disabled")"
                       aria-disabled="@(!Model.PagedItems.HasPreviousPage)">
                        <i class="bi bi-chevron-double-left"></i>
                    </a>

                    <span class="btn btn-outline-primary active">
                        @Model.PagedItems.PageIndex
                    </span>

                    <a asp-controller="Users"
                       asp-action="List"
                       asp-route-isActive="@Model.IsActive"
                       asp-route-sortOrder="@Model.SortOrder"
                       asp-route-sortField="@Model.SortField"
                       asp-route-pageNumber="@(Model.PagedItems.PageIndex + 1)"
                       class="btn btn-outline-primary @(Model.PagedItems.HasNextPage ? "" : "disabled")"
                       aria-disabled="@(!Model.PagedItems.HasNextPage)">
                        <i class="bi bi-chevron-double-right"></i>
                    </a>
                </div>
            </div>

            <div class="col-4 text-end">
                <div class="btn-group" role="group">
                    <a asp-action="Create" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add User
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_DeleteModal")

@section Scripts {
    <script>
        const deleteModal = document.getElementById('deleteModal')

        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;

            const userId = button.getAttribute('data-user-id');
            const userName = button.getAttribute('data-user-name');

            document.getElementById("deleteUserId").value = userId;
            document.getElementById("deleteUserName").textContent = userName;

            document.getElementById("deleteForm").action = "/users/delete";
        });
    </script>
}
